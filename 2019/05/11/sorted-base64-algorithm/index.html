<!DOCTYPE html>
<html lang=zh>
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="keywords" content="">
  
    <link rel="icon" href="">
  
    
  <title>Sorted base64 algorithm | 上下未形，何由考之？冥昭瞢暗，誰能極之？馮翼惟象，何以識之？</title>
  <meta name="description" content="">
  
<link rel="stylesheet" href="/style.css">

  
<link rel="stylesheet" href="/lib/jquery.fancybox.min.css">

  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <header>
  <div class="header-container">
    <a class='logo' href="/">
      <span>上下未形，何由考之？冥昭瞢暗，誰能極之？馮翼惟象，何以識之？</span>
    </a>
    <ul class="right-header">
      
        <li class="nav-item">
          
            <a href="/" class="item-link">首页</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/about" class="item-link">关于</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/archives" class="item-link">归档</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/tags" class="item-link">标签</a>
          
        </li>
      
    </ul>
  </div>
</header>

  <main id='post'>
  <div class="content">
    <article>
      <section class="content markdown-body">
        <h1>
          Sorted base64 algorithm
        </h1>
        <div class='post-meta'>
          <i class="fa fa-calendar"
            aria-hidden="true"></i> <time>
            2019/05/11</time>
          
          | <i class="fa fa-folder-open-o"
            aria-hidden="true"></i>
          
  <div class="article-category">
    <a class="article-category-link" href="/categories/Programming/">Programming</a>/ <a class="article-category-link" href="/categories/Programming/Java/">Java</a>
  </div>



          
          
          |
          
          <i class="fa fa-tag"
            aria-hidden="true"></i>
          
          
  <a href="/tags/#Java" class='tag'>Java</a>


          
        </div>
        <h1 id="Sorted-Base64"><a href="#Sorted-Base64" class="headerlink" title="Sorted Base64"></a>Sorted Base64</h1><p>The standard base64 algorithm does not preserve the order of the original data, so we need sorted base64 algorithm.</p>
<p>URL safe characters include uppercase and lowercase letters, decimal digits, hyphen, period, underscore, and tilde, i.e. ALPHA &#x2F; DIGIT &#x2F; “-“ &#x2F; “.” &#x2F; “_” &#x2F; “~”.</p>
<p>Sorted Base64 encoding scheme use ‘-‘, decimal digits, uppercase letters, ‘_’, lowercase letters, in the ASCII table order.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Sorted Base64 without padding bytes.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * URL safe characters include uppercase and lowercase letters, decimal digits,</span></span><br><span class="line"><span class="comment"> * hyphen, period, underscore, and tilde, i.e. ALPHA / DIGIT / &quot;-&quot; / &quot;.&quot; / &quot;_&quot; / &quot;~&quot;.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Sorted Base64 encoding scheme use &#x27;-&#x27;, decimal digits, uppercase letters, &#x27;_&#x27;,</span></span><br><span class="line"><span class="comment"> * lowercase letters, in the ASCII table order.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SortedBase64</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">SortedBase64</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a &#123;<span class="doctag">@link</span> Encoder&#125; that encodes using the</span></span><br><span class="line"><span class="comment">     * Sorted base64 encoding scheme.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> A Sorted Base64 encoder.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Encoder <span class="title function_">getEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Encoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a &#123;<span class="doctag">@link</span> Decoder&#125; that decodes using the</span></span><br><span class="line"><span class="comment">     * Sorted base64 encoding scheme.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> A Sorted Base64 decoder.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Decoder <span class="title function_">getDecoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Decoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This class implements an encoder for encoding byte data using</span></span><br><span class="line"><span class="comment">     * the Sorted Base64 &#123;<span class="doctag">@link</span> SortedBase64&#125; encoding scheme.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; Instances of &#123;<span class="doctag">@link</span> Encoder&#125; class are safe for use by</span></span><br><span class="line"><span class="comment">     * multiple concurrent threads.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Encoder</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">Encoder</span><span class="params">()</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * This array is a lookup table that translates 6-bit positive integer</span></span><br><span class="line"><span class="comment">         * index values into their &quot;Sorted Base64 Alphabet&quot;.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">char</span>[] toSortedBase64 = &#123;</span><br><span class="line">                <span class="string">&#x27;-&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;9&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;G&#x27;</span>, <span class="string">&#x27;H&#x27;</span>, <span class="string">&#x27;I&#x27;</span>, <span class="string">&#x27;J&#x27;</span>, <span class="string">&#x27;K&#x27;</span>, <span class="string">&#x27;L&#x27;</span>, <span class="string">&#x27;M&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;N&#x27;</span>, <span class="string">&#x27;O&#x27;</span>, <span class="string">&#x27;P&#x27;</span>, <span class="string">&#x27;Q&#x27;</span>, <span class="string">&#x27;R&#x27;</span>, <span class="string">&#x27;S&#x27;</span>, <span class="string">&#x27;T&#x27;</span>, <span class="string">&#x27;U&#x27;</span>, <span class="string">&#x27;V&#x27;</span>, <span class="string">&#x27;W&#x27;</span>, <span class="string">&#x27;X&#x27;</span>, <span class="string">&#x27;Y&#x27;</span>, <span class="string">&#x27;Z&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;i&#x27;</span>, <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;k&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;m&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;q&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;u&#x27;</span>, <span class="string">&#x27;v&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;z&#x27;</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">outLength</span><span class="params">(<span class="type">int</span> srcLen)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (srcLen * <span class="number">8</span> + <span class="number">5</span>) / <span class="number">6</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Encodes the specified byte array into a String using the &#123;<span class="doctag">@link</span> SortedBase64&#125;</span></span><br><span class="line"><span class="comment">         * encoding scheme.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">encode</span><span class="params">(<span class="type">byte</span>[] src)</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] encoded = <span class="keyword">new</span> <span class="title class_">byte</span>[outLength(src.length)];</span><br><span class="line">            encode(src, <span class="number">0</span>, encoded, <span class="number">0</span>, src.length);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(encoded, <span class="number">0</span>, encoded.length, StandardCharsets.ISO_8859_1);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Encodes an array from the specified source array, beginning at the</span></span><br><span class="line"><span class="comment">         * specified position, to the specified position of the destination array,</span></span><br><span class="line"><span class="comment">         * using the &#123;<span class="doctag">@link</span> SortedBase64&#125; encoding scheme. The number of bytes</span></span><br><span class="line"><span class="comment">         * encoded is equal to the &lt;code&gt;length&lt;/code&gt; argument. The returned</span></span><br><span class="line"><span class="comment">         * value is of the length of the resulting bytes.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">encode</span><span class="params">(<span class="type">byte</span>[] src, <span class="type">int</span> srcPos, <span class="type">byte</span>[] dst, <span class="type">int</span> dstPos, <span class="type">int</span> length)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (srcPos + length &gt; src.length || outLength(length) + dstPos &gt; dst.length) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Output byte array is too small for encoding all input bytes&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">sp</span> <span class="operator">=</span> srcPos;</span><br><span class="line">            <span class="type">int</span> <span class="variable">s1</span> <span class="operator">=</span> srcPos + (length / <span class="number">3</span>) * <span class="number">3</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">dp</span> <span class="operator">=</span> dstPos;</span><br><span class="line">            <span class="keyword">while</span> (sp &lt; s1) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">bits</span> <span class="operator">=</span> (src[sp++] &amp; <span class="number">0xff</span>) &lt;&lt; <span class="number">16</span> | (src[sp++] &amp; <span class="number">0xff</span>) &lt;&lt; <span class="number">8</span> | (src[sp++] &amp; <span class="number">0xff</span>);</span><br><span class="line"></span><br><span class="line">                dst[dp++] = (<span class="type">byte</span>) toSortedBase64[(bits &gt;&gt;&gt; <span class="number">18</span>) &amp; <span class="number">0x3f</span>];</span><br><span class="line">                dst[dp++] = (<span class="type">byte</span>) toSortedBase64[(bits &gt;&gt;&gt; <span class="number">12</span>) &amp; <span class="number">0x3f</span>];</span><br><span class="line">                dst[dp++] = (<span class="type">byte</span>) toSortedBase64[(bits &gt;&gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x3f</span>];</span><br><span class="line">                dst[dp++] = (<span class="type">byte</span>) toSortedBase64[bits &amp; <span class="number">0x3f</span>];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">s2</span> <span class="operator">=</span> srcPos + length;</span><br><span class="line">            <span class="keyword">if</span> (s1 &lt; s2) &#123;</span><br><span class="line">                <span class="comment">// 1 or 2 leftover bytes</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">b0</span> <span class="operator">=</span> src[sp++] &amp; <span class="number">0xff</span>;</span><br><span class="line">                dst[dp++] = (<span class="type">byte</span>) toSortedBase64[b0 &gt;&gt; <span class="number">2</span>];</span><br><span class="line">                <span class="keyword">if</span> (sp == s2) &#123;</span><br><span class="line">                    dst[dp++] = (<span class="type">byte</span>) toSortedBase64[(b0 &lt;&lt; <span class="number">4</span>) &amp; <span class="number">0x3f</span>];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">b1</span> <span class="operator">=</span> src[sp] &amp; <span class="number">0xff</span>;</span><br><span class="line">                    dst[dp++] = (<span class="type">byte</span>) toSortedBase64[(b0 &lt;&lt; <span class="number">4</span>) &amp; <span class="number">0x3f</span> | (b1 &gt;&gt; <span class="number">4</span>)];</span><br><span class="line">                    dst[dp++] = (<span class="type">byte</span>) toSortedBase64[(b1 &lt;&lt; <span class="number">2</span>) &amp; <span class="number">0x3f</span>];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> dp - dstPos;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This class implements a decoder for decoding byte data using the</span></span><br><span class="line"><span class="comment">     * Sorted Base64 &#123;<span class="doctag">@link</span> SortedBase64&#125; encoding scheme.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; Instances of &#123;<span class="doctag">@link</span> Decoder&#125; class are safe for use by</span></span><br><span class="line"><span class="comment">     * multiple concurrent threads.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Decoder</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">Decoder</span><span class="params">()</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Lookup table for decoding unicode characters drawn from the</span></span><br><span class="line"><span class="comment">         * &quot;Sorted Base64 Alphabet&quot; into their 6-bit positive integer</span></span><br><span class="line"><span class="comment">         * equivalents. Characters that are not in the Sorted Base64</span></span><br><span class="line"><span class="comment">         * alphabet but fall within the bounds of the array are encoded to -1.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span>[] fromSortedBase64 = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">128</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> &#123;</span><br><span class="line">            Arrays.fill(fromSortedBase64, -<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; SortedBase64.Encoder.toSortedBase64.length; i++)</span><br><span class="line">                fromSortedBase64[SortedBase64.Encoder.toSortedBase64[i]] = i;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">outLength</span><span class="params">(<span class="type">int</span> srcLen)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (srcLen * <span class="number">6</span>) / <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Decodes a Base64 encoded String into a newly-allocated byte array</span></span><br><span class="line"><span class="comment">         * using the &#123;<span class="doctag">@link</span> SortedBase64&#125; encoding scheme.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">byte</span>[] decode(String b64) &#123;</span><br><span class="line">            <span class="type">byte</span>[] src = b64.getBytes(StandardCharsets.ISO_8859_1);</span><br><span class="line">            <span class="type">byte</span>[] dst = <span class="keyword">new</span> <span class="title class_">byte</span>[outLength(src.length)];</span><br><span class="line">            <span class="type">int</span> <span class="variable">ret</span> <span class="operator">=</span> decode(src, <span class="number">0</span>, dst, <span class="number">0</span>, src.length);</span><br><span class="line">            <span class="keyword">if</span> (ret != dst.length) &#123;</span><br><span class="line">                dst = Arrays.copyOf(dst, ret);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> dst;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Decodes an array from the specified source array, beginning at the</span></span><br><span class="line"><span class="comment">         * specified position, to the specified position of the destination array,</span></span><br><span class="line"><span class="comment">         * using the &#123;<span class="doctag">@link</span> SortedBase64&#125; encoding scheme. The number of bytes</span></span><br><span class="line"><span class="comment">         * decoded is equal to the &lt;code&gt;length&lt;/code&gt; argument. The returned</span></span><br><span class="line"><span class="comment">         * value is of the length of the resulting bytes.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">decode</span><span class="params">(<span class="type">byte</span>[] src, <span class="type">int</span> srcPos, <span class="type">byte</span>[] dst, <span class="type">int</span> dstPos, <span class="type">int</span> length)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (length &lt; <span class="number">2</span> || length % <span class="number">4</span> == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Input byte array has invalid length for decoding&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (srcPos + length &gt; src.length || outLength(length) + dstPos &gt; dst.length) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Output byte array is too small for decoding all input bytes&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">sp</span> <span class="operator">=</span> srcPos;</span><br><span class="line">            <span class="type">int</span> <span class="variable">s1</span> <span class="operator">=</span> srcPos + (length / <span class="number">4</span>) * <span class="number">4</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">dp</span> <span class="operator">=</span> dstPos;</span><br><span class="line">            <span class="keyword">while</span> (sp &lt; s1) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">bits</span> <span class="operator">=</span> (fromSortedBase64[src[sp++]] &amp; <span class="number">0x3f</span>) &lt;&lt; <span class="number">18</span> | (fromSortedBase64[src[sp++]] &amp; <span class="number">0x3f</span>) &lt;&lt; <span class="number">12</span></span><br><span class="line">                        | (fromSortedBase64[src[sp++]] &amp; <span class="number">0x3f</span>) &lt;&lt; <span class="number">6</span> | (fromSortedBase64[src[sp++]] &amp; <span class="number">0x3f</span>);</span><br><span class="line"></span><br><span class="line">                dst[dp++] = (<span class="type">byte</span>) (bits &gt;&gt; <span class="number">16</span>);</span><br><span class="line">                dst[dp++] = (<span class="type">byte</span>) (bits &gt;&gt; <span class="number">8</span>);</span><br><span class="line">                dst[dp++] = (<span class="type">byte</span>) (bits);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">s2</span> <span class="operator">=</span> srcPos + length;</span><br><span class="line">            <span class="keyword">if</span> (s1 &lt; s2) &#123;</span><br><span class="line">                <span class="comment">// 2 or 3 leftover bytes</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">b0</span> <span class="operator">=</span> (fromSortedBase64[src[sp++]] &amp; <span class="number">0x3f</span>) &lt;&lt; <span class="number">6</span> | (fromSortedBase64[src[sp++]] &amp; <span class="number">0x3f</span>);</span><br><span class="line">                <span class="keyword">if</span> (sp == s2) &#123;</span><br><span class="line">                    dst[dp++] = (<span class="type">byte</span>) (b0 &gt;&gt; <span class="number">4</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">b1</span> <span class="operator">=</span> (b0 &lt;&lt; <span class="number">4</span>) | ((fromSortedBase64[src[sp]] &amp; <span class="number">0x3f</span>) &gt;&gt; <span class="number">2</span>);</span><br><span class="line">                    dst[dp++] = (<span class="type">byte</span>) (b1 &gt;&gt; <span class="number">8</span>);</span><br><span class="line">                    dst[dp++] = (<span class="type">byte</span>) (b1);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> dp - dstPos;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      </section>
    </article>
    
    
  </div>
  <aside>
    
    <div class="toc-container">
      <h1>
        catalog
      </h1>
      <div class="content">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Sorted-Base64"><span class="toc-number">1.</span> <span class="toc-text">Sorted Base64</span></a></li></ol>
      </div>
    </div>
    
  </aside>
</main>



  <footer>
  <div class="copyright">
    <div>
      &copy;
      2024 | Powered by <a href="https://hexo.io"
        target="_blank">Hexo</a>&nbsp
    </div>
    <div>
      Theme by <a href="https://github.com/lewis-geek/hexo-theme-Aath"
        target="_blank">Aath</a>
    </div>
  </div>
</footer>


<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>

<script src="/lib/ScrollMagic.min.js"></script>


<script src="/lib/lodash.min.js"></script>

<script>
  document.body.addEventListener('touchstart', function () { });

  // 文章图片预览
  $("article img").each(function () {
    var strA = "<a data-fancybox='gallery' href='" + this.src + "'></a>";
    $(this).wrapAll(strA);
  });

  // 目录联动
  let tocLinkList = $('.toc-link')

  let controller = new ScrollMagic.Controller({
    globalSceneOptions: {
      triggerHook: 0.01
    }
  })

  tocLinkList.each(function (index, elem) {
    let href = $(this).attr("href");
    let nextHref = tocLinkList.eq(index + 1).attr("href");
    let height = href && nextHref ? $(nextHref).offset().top - $(href).offset().top : 0

    new ScrollMagic.Scene({ triggerElement: href })
      .duration(height)
      .setClassToggle(".toc [href='" + href + "']", 'active')
      .addTo(controller)
  })

  window.addEventListener('load', function () {
    // 目录联动 图片加载完成后从新计算
    tocLinkList.each(function (index, elem) {
      let href = $(this).attr("href");
      let nextHref = tocLinkList.eq(index + 1).attr("href");
      let height = href && nextHref ? $(nextHref).offset().top - $(href).offset().top : 0

      new ScrollMagic.Scene({ triggerElement: href })
        .duration(height)
        .setClassToggle(".toc [href='" + href + "']", 'active')
        .addTo(controller)
    })
  })
</script>

<script src="/lib/jquery.fancybox.min.js"></script>



</body>
</html>
